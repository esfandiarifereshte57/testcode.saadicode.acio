<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0088cc">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="پاترونوس">
    <meta name="description" content="پیام‌رسان امن و سریع پاترونوس - از تیم آکیو">
    <meta name="keywords" content="پیام‌رسان, چت, امن, سریع, پاترونوس, آکیو">
    <meta name="author" content="تیم آکیو - ۲۰۲۵">
    
    <!-- Favicon and App Icons -->
    <link rel="icon" type="image/x-icon" href="https://uploadkon.ir/uploads/867323_25IMG-4467.jpeg">
    <link rel="apple-touch-icon" href="https://uploadkon.ir/uploads/867323_25IMG-4467.jpeg">
    
    <title>پاترونوس | پیام‌رسان امن و سریع</title>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================================
           PATRONUS PREMIUM STYLESHEET (Advanced Glassmorphism UI)
           ============================================================ */
        :root {
            --p-primary: #0088cc; --p-primary-dark: #0077b5;
            --p-bg: #f0f2f5; --p-side: #ffffff; --p-surface: #ffffff;
            --p-text: #000000; --p-text-sub: #707579; --p-border: #dfe1e5;
            --p-msg-in: #ffffff; --p-msg-out: #effdde; --p-accent: #2196f3;
            --p-radius: 15px; --p-shadow: 0 10px 30px rgba(0,0,0,0.08);
            --p-anim: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Themes Configuration */
        body.theme-dark {
            --p-bg: #0e1621; --p-side: #17212b; --p-surface: #17212b;
            --p-text: #ffffff; --p-text-sub: #8b96a1; --p-border: #232e3c;
            --p-msg-in: #182533; --p-msg-out: #2b5278; --p-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        body.theme-blue { --p-primary: #2196f3; --p-bg: #e3f2fd; }
        body.theme-green { --p-primary: #4caf50; --p-bg: #e8f5e9; }
        body.theme-purple { --p-primary: #9c27b0; --p-bg: #f3e5f5; }
        body.theme-red { --p-primary: #f44336; --p-bg: #ffebee; }

        * { box-sizing: border-box; font-family: 'Vazirmatn', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body, html { margin: 0; padding: 0; height: 100vh; overflow: hidden; background: var(--p-bg); color: var(--p-text); transition: var(--p-anim); }

        /* Splash & Loader */
        #splash { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        body.theme-dark #splash { background: #0e1621; }
        .logo-anim { width: 120px; border-radius: 35px; animation: pulse 2s infinite; box-shadow: var(--p-shadow); }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* Auth Box */
        #auth-box { display: none; height: 100vh; align-items: center; justify-content: center; background: linear-gradient(135deg, #0088cc, #004466); }
        .auth-card { background: var(--p-surface); padding: 40px; border-radius: 30px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .auth-card h2 { margin-bottom: 20px; }
        .auth-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 15px; border: 1px solid #ddd; }
        .auth-btn { width: 100%; padding: 15px; background: var(--p-primary); color: #fff; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; }
        .auth-message { margin-top: 15px; font-size: 14px; color: #f44336; }

        /* Main Layout */
        #app-wrapper { display: none; height: 100vh; grid-template-columns: 380px 1fr; }
        #app-wrapper.active { display: grid; }

        /* Sidebar */
        .sidebar { background: var(--p-side); border-left: 1px solid var(--p-border); display: flex; flex-direction: column; position: relative; z-index: 10; }
        .sidebar-header { padding: 15px; display: flex; align-items: center; gap: 10px; }
        .search-container { flex: 1; background: var(--p-bg); border-radius: 20px; padding: 8px 15px; display: flex; align-items: center; gap: 10px; }
        .search-container input { background: transparent; border: none; flex: 1; color: var(--p-text); }

        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px 18px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .chat-item:hover { background: rgba(0,0,0,0.05); }
        .chat-item.active { background: var(--p-primary); color: #fff; }
        .chat-item.active .m-preview { color: rgba(255,255,255,0.8); }

        .p-avatar { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; background: #ddd; position: relative; }
        .online-status { position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #4caf50; border: 2px solid var(--p-side); border-radius: 50%; }

        /* Chat Window */
        .chat-window { display: flex; flex-direction: column; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: var(--p-bg); background-size: 350px; }
        .chat-header { background: var(--p-surface); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--p-border); box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        
        .messages-container { flex: 1; overflow-y: auto; padding: 20px 7%; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
        .bubble { max-width: 70%; padding: 10px 15px; border-radius: 18px; position: relative; font-size: 14.5px; line-height: 1.5; box-shadow: 0 1px 2px rgba(0,0,0,0.1); animation: fadeInUp 0.3s; }
        .bubble.sent { align-self: flex-end; background: var(--p-msg-out); border-bottom-right-radius: 4px; color: #000; }
        .bubble.received { align-self: flex-start; background: var(--p-msg-in); border-bottom-left-radius: 4px; }
        .b-meta { font-size: 10px; margin-top: 4px; opacity: 0.6; text-align: left; }

        .input-bar { padding: 15px 7%; background: transparent; display: flex; align-items: center; gap: 10px; }
        .input-inner { background: var(--p-surface); flex: 1; border-radius: 25px; padding: 5px 15px; display: flex; align-items: center; box-shadow: var(--p-shadow); }
        .input-inner input { flex: 1; padding: 10px; border: none; background: transparent; color: var(--p-text); font-size: 15px; }

        /* Modals & Advanced Settings */
        .p-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .p-modal-content { background: var(--p-surface); width: 90%; max-width: 550px; border-radius: 25px; max-height: 85vh; overflow-y: auto; animation: zoomIn 0.3s; padding: 25px; }
        .setting-row { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--p-border); }
        
        /* Footer */
        .footer-tag { font-size: 11px; text-align: center; padding: 10px; color: var(--p-text-sub); border-top: 1px solid var(--p-border); }

        @media (max-width: 900px) {
            #app-wrapper { grid-template-columns: 1fr; }
            .chat-window { position: fixed; inset: 0; z-index: 100; transform: translateX(100%); transition: 0.3s; }
            .chat-window.active { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <div id="splash">
        <img src="https://uploadkon.ir/uploads/867323_25IMG-4467.jpeg" class="logo-anim">
        <h1 style="margin-top: 20px; font-weight: 900; color: #0088cc;">PATRONUS</h1>
    </div>

    <div id="auth-box" style="display:none; height:100vh; align-items:center; justify-content:center; background: linear-gradient(135deg, #0088cc, #004466);">
        <div style="background:var(--p-surface); padding:40px; border-radius:30px; width:100%; max-width:400px; text-align:center; box-shadow: 0 20px 50px rgba(0,0,0,0.2);">
            <h2 id="lang-auth-title">ورود به پاترونوس</h2>
            <input type="text" id="auth-uid" placeholder="آیدی کاربری" style="width:100%; padding:15px; margin:10px 0; border-radius:15px; border:1px solid #ddd;">
            <input type="password" id="auth-pwd" placeholder="رمز عبور" style="width:100%; padding:15px; margin:10px 0; border-radius:15px; border:1px solid #ddd;">
            <button onclick="Engine.login()" style="width:100%; padding:15px; background:var(--p-primary); color:#fff; border:none; border-radius:15px; font-weight:bold; cursor:pointer;">ورود</button>
            <p style="margin-top:20px; font-size:14px; cursor:pointer" onclick="alert('لطفاً با ادمین تماس بگیرید')">حساب ندارید؟ ثبت نام</p>
        </div>
    </div>

    <div id="app-wrapper">
        <aside class="sidebar">
            <div class="sidebar-header">
                <button onclick="Engine.openSettings()" style="background:none; border:none; font-size:20px; color:var(--p-text); cursor:pointer"><i class="fas fa-bars"></i></button>
                <div class="search-container">
                    <i class="fas fa-search" style="color:var(--p-text-sub)"></i>
                    <input type="text" id="search-input" placeholder="جستجو...">
                </div>
            </div>
            <div class="chat-list" id="dom-chat-list"></div>
            <div class="footer-tag">طراحی و توسعه توسط <a href="https://aciocode.vercel.app" style="color:var(--p-primary); text-decoration:none;">تیم آکیو</a></div>
        </aside>

        <main class="chat-window" id="dom-chat-view">
            <header class="chat-header">
                <div style="display:flex; align-items:center; gap:12px">
                    <button class="mobile-only" onclick="Engine.closeChat()" style="background:none; border:none; font-size:18px;"><i class="fas fa-arrow-right"></i></button>
                    <div id="active-avatar" class="p-avatar" style="width:45px; height:45px;"></div>
                    <div>
                        <b id="active-name">Patronus</b><br>
                        <small id="active-status" style="color:#4caf50">online</small>
                    </div>
                </div>
                <div style="display:flex; gap:20px; color:var(--p-text-sub)">
                    <i class="fas fa-search"></i>
                    <i class="fas fa-ellipsis-v"></i>
                </div>
            </header>
            <div class="messages-container" id="dom-messages"></div>
            <div class="input-bar">
                <div class="input-inner">
                    <i class="far fa-smile" style="color:var(--p-text-sub); cursor:pointer"></i>
                    <input type="text" id="main-input" placeholder="پیام...">
                    <i class="fas fa-paperclip" style="color:var(--p-text-sub); cursor:pointer"></i>
                </div>
                <button onclick="Engine.sendMessage()" style="width:50px; height:50px; border-radius:50%; background:var(--p-primary); color:#fff; border:none; cursor:pointer; font-size:18px;"><i class="fas fa-paper-plane"></i></button>
            </div>
        </main>
    </div>

    <div id="modal-settings" class="p-modal">
        <div class="p-modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center">
                <h2>تنظیمات پیشرفته</h2>
                <button onclick="Engine.closeModals()" style="background:none; border:none; font-size:24px;">&times;</button>
            </div>
            <div class="setting-row">
                <span><i class="fas fa-language"></i> زبان اپلیکیشن</span>
                <select id="lang-select" onchange="Engine.setLang(this.value)">
                    <option value="fa">فارسی</option>
                    <option value="en">English</option>
                    <option value="ar">العربية</option>
                    <option value="tr">Türkçe</option>
                    <option value="ru">Русский</option>
                </select>
            </div>
            <div class="setting-row">
                <span><i class="fas fa-palette"></i> انتخاب تم</span>
                <div style="display:flex; gap:5px">
                    <div onclick="Engine.setTheme('dark')" style="width:25px; height:25px; background:#1c242f; border-radius:50%; cursor:pointer"></div>
                    <div onclick="Engine.setTheme('blue')" style="width:25px; height:25px; background:#2196f3; border-radius:50%; cursor:pointer"></div>
                    <div onclick="Engine.setTheme('purple')" style="width:25px; height:25px; background:#9c27b0; border-radius:50%; cursor:pointer"></div>
                </div>
            </div>
            <div class="setting-row">
                <span><i class="fas fa-bell"></i> صدای اعلان‌ها</span>
                <input type="checkbox" checked>
            </div>
            <div class="setting-row">
                <span><i class="fas fa-shield-alt"></i> تایید دو مرحله‌ای</span>
                <button style="font-size:12px">فعالسازی</button>
            </div>
            <br>
            <button onclick="Engine.logout()" style="width:100%; padding:12px; background:#f44336; color:#fff; border:none; border-radius:10px; font-weight:bold;">خروج از حساب</button>
        </div>
    </div>

    <script>
        const API = 'https://script.google.com/macros/s/AKfycbx58pC2wvnCrM4a_3XeIESwR1lW_Wn7Qcw7J6jtOXozGITO3JLu4tTzFUE_iBUQxoPh/exec';
        
        const Engine = {
            user: JSON.parse(localStorage.getItem('p_session')),
            chatId: null,
            lang: 'fa',

            init: function() {
                setTimeout(() => {
                    document.getElementById('splash').style.display = 'none';
                    if(this.user) {
                        this.startApp();
                    } else {
                        document.getElementById('auth-box').style.display = 'flex';
                    }
                }, 2500);
                
                document.getElementById('main-input').addEventListener('keypress', (e) => {
                    if(e.key === 'Enter') this.sendMessage();
                });
            },

            async call(data) {
                try {
                    const r = await fetch(API, { method: 'POST', body: JSON.stringify(data) });
                    return await r.json();
                } catch(e) { return {ok:false}; }
            },

            login: async function() {
                const id = document.getElementById('auth-uid').value;
                const ps = document.getElementById('auth-pwd').value;
                const res = await this.call({ action:'login', userid:id, password:ps });
                if(res.ok) {
                    this.user = res.user;
                    localStorage.setItem('p_session', JSON.stringify(res.user));
                    location.reload();
                } else { alert('خطا در ورود'); }
            },

            startApp: function() {
                document.getElementById('auth-box').style.display = 'none';
                document.getElementById('app-wrapper').classList.add('active');
                this.loadChats();
                setInterval(() => this.loadChats(), 10000);
            },

            loadChats: async function() {
                const res = await this.call({ action:'getChats', userId: this.user.userid });
                if(res.ok) {
                    const list = document.getElementById('dom-chat-list');
                    list.innerHTML = '';
                    res.chats.forEach(c => {
                        list.innerHTML += `
                            <div class="chat-item ${this.chatId === c.id ? 'active' : ''}" onclick="Engine.openChat('${c.id}', '${c.name}')">
                                <div class="p-avatar">
                                    <img src="https://ui-avatars.com/api/?name=${c.name}&background=random" style="width:100%; border-radius:50%">
                                    ${c.online ? '<div class="online-status"></div>' : ''}
                                </div>
                                <div style="flex:1">
                                    <div style="display:flex; justify-content:space-between"><b>${c.name}</b> <small>${c.lastMessageTime ? 'now' : ''}</small></div>
                                    <div class="m-preview" style="font-size:12px; opacity:0.7">${c.lastMessage || '...'}</div>
                                </div>
                            </div>
                        `;
                    });
                }
            },

            openChat: function(id, name) {
                this.chatId = id;
                document.getElementById('active-name').innerText = name;
                document.getElementById('active-avatar').innerHTML = `<img src="https://ui-avatars.com/api/?name=${name}&background=random" style="width:100%; border-radius:50%">`;
                document.getElementById('dom-chat-view').classList.add('active');
                this.loadMessages();
            },

            loadMessages: async function() {
                if(!this.chatId) return;
                const res = await this.call({ action:'getMessages', chatId: this.chatId });
                if(res.ok) {
                    const cont = document.getElementById('dom-messages');
                    cont.innerHTML = '';
                    res.messages.forEach(m => {
                        const isMe = m.senderId === this.user.userid;
                        cont.innerHTML += `
                            <div class="bubble ${isMe ? 'sent' : 'received'} animate__animated animate__fadeInUp">
                                ${m.text}
                                <div class="b-meta">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                            </div>
                        `;
                    });
                    cont.scrollTop = cont.scrollHeight;
                }
            },

            sendMessage: async function() {
                const inp = document.getElementById('main-input');
                const txt = inp.value;
                if(!txt || !this.chatId) return;
                inp.value = '';
                await this.call({ action:'sendMessage', chatId:this.chatId, senderId:this.user.userid, text:txt });
                this.loadMessages();
            },

            setTheme: (t) => document.body.className = 'theme-' + t,
            openSettings: () => document.getElementById('modal-settings').style.display = 'flex',
            closeModals: () => document.querySelectorAll('.p-modal').forEach(m => m.style.display = 'none'),
            closeChat: () => document.getElementById('dom-chat-view').classList.remove('active'),
            logout: () => { localStorage.clear(); location.reload(); }
        };

        Engine.init();
    </script>
</body>
</html>